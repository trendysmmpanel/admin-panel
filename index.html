<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMM Admin Panel (Master)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <style>
        :root { --bg: #1e1e2f; --card: #27293d; --primary: #e14eca; --success: #00f2c3; --danger: #fd5d93; --text: #ffffff; }
        
        * { box-sizing: border-box; } 
        
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 50px; -webkit-font-smoothing: antialiased; }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        
        h1, h2 { border-bottom: 2px solid var(--primary); padding-bottom: 10px; display: inline-block; margin-top: 30px; font-size: 1.5rem; word-break: break-word; }
        
        /* Login Overlay Styles */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            background: var(--card); padding: 40px; border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 100%; max-width: 400px;
            border-top: 5px solid var(--primary); text-align: center;
        }
        .login-box h2 { border: none; margin-top: 0; }
        
        /* Responsive Grid for Stats */
        .grid-3 { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 15px; 
            margin-bottom: 30px; 
        }

        .stat-card { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border-left: 4px solid var(--primary); }
        .stat-num { font-size: 1.8em; font-weight: bold; color: var(--text); margin-top: 10px; word-wrap: break-word; }
        
        .section { background: var(--card); padding: 15px; margin-bottom: 30px; border-radius: 8px; border: 1px solid #333; overflow: hidden; }
        
        /* Form Elements */
        input, select { 
            width: 100%; 
            padding: 12px; 
            margin: 5px 0 15px 0; 
            background: #1e1e2f; 
            border: 1px solid #444; 
            color: white; 
            border-radius: 4px; 
            font-size: 16px; 
        }
        
        button { background: var(--primary); color: white; border: none; padding: 12px 20px; cursor: pointer; font-weight: bold; border-radius: 4px; transition: 0.2s; white-space: nowrap; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button.green { background: var(--success); color: #000; }
        button.red { background: var(--danger); }

        /* Row Inputs Layout */
        .row-inputs { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }
        .row-inputs > * { flex: 1; min-width: 200px; } 
        .row-inputs button { flex: 0 0 auto; } 

        /* Table Responsive */
        .table-responsive { 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
            margin-top: 10px;
            border-radius: 4px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 600px; }
        th, td { padding: 12px; border-bottom: 1px solid #444; text-align: left; }
        th { background: #333; color: var(--primary); white-space: nowrap; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; }
        .b-pending { background: orange; color: black; }
        .b-completed { background: var(--success); color: black; }
        .b-canceled { background: var(--danger); color: white; }

        @media (max-width: 900px) {
            .grid-3 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 600px) {
            .grid-3 { grid-template-columns: 1fr; } 
            
            .row-inputs { flex-direction: column; align-items: stretch; gap: 5px; }
            .row-inputs > * { width: 100% !important; margin-bottom: 5px; flex: auto; }
            
            input, select { margin-bottom: 10px; }
            button { width: 100%; margin-top: 5px; }

            h1 { font-size: 1.4rem; margin-top: 15px; }
            h2 { font-size: 1.2rem; }
            
            .container { padding: 10px; }
            .stat-card { padding: 15px; }
            
            #qr-file { padding: 10px; background: transparent; border: none; }
        }
        
        /* Dashboard hidden initially */
        #dashboard-content { display: none; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2>üîí Admin Access</h2>
        <p style="color:#aaa; font-size:13px; margin-bottom:20px;">Please login to manage the panel.</p>
        <form id="adminLoginForm">
            <input type="text" id="admin-user" placeholder="Username" required>
            <input type="password" id="admin-pass" placeholder="Password" required>
            <button type="submit" style="width:100%; margin-top:10px;">LOGIN TO DASHBOARD</button>
        </form>
        <p id="login-msg" style="margin-top:15px; font-size:12px;"></p>
    </div>
</div>

<div class="container" id="dashboard-content">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>üõ† Admin Dashboard</h1>
        <button onclick="adminLogout()" class="red" style="padding:8px 15px; font-size:12px;">LOGOUT</button>
    </div>

    <div class="grid-3">
        <div class="stat-card">
            <div>Total Users</div>
            <div class="stat-num" id="count-users">0</div>
        </div>
        <div class="stat-card">
            <div>Total Orders (Real)</div>
            <div class="stat-num" id="count-orders">0</div>
        </div>
        <div class="stat-card">
            <div>Pending Payment Requests</div>
            <div class="stat-num" id="count-pay-req" style="color:orange">0</div>
        </div>
    </div>

    <div class="section">
        <h2>‚öôÔ∏è Site Settings</h2>
        <p style="font-size:13px; color:#aaa;">Set the "Base" number. Total displayed to users will be: <b>Base + Real Orders</b>.</p>
        <div class="row-inputs">
            <div style="flex:2;">
                <label>Fake Base Order Count</label>
                <input type="number" id="fake-count" placeholder="e.g. 50000">
            </div>
            <button onclick="saveSettings()">SAVE SETTINGS</button>
        </div>
        
        <div style="margin-top: 20px; border-top: 1px solid #444; padding-top: 15px;">
             <h3>üì∑ Update QR Code</h3>
             <div class="row-inputs">
                 <input type="file" id="qr-file">
                 <button onclick="uploadQR()">UPLOAD NEW QR</button>
             </div>
             <p id="qr-status" style="color: var(--success);"></p>
        </div>
    </div>

    <div class="section">
        <h2>üí∏ Payment Requests</h2>
        <div class="table-responsive">
            <table>
                <thead><tr><th>User</th><th>Amount</th><th>Txn ID</th><th>Date</th><th>Action</th></tr></thead>
                <tbody id="payments-table"></tbody>
            </table>
        </div>
    </div>

    <div class="section">
        <h2>üí∞ Manual Fund Addition</h2>
        <div class="row-inputs">
            <input type="text" id="coin-username" placeholder="Exact Username">
            <input type="number" id="coin-amount" placeholder="Amount (‚Çπ)">
            <button onclick="findAndUpdateBalance()">ADD BALANCE</button>
        </div>
    </div>

    <div class="section">
        <h2>‚ûï Services Manager</h2>
        <div class="row-inputs">
            <input type="text" id="svc-name" placeholder="Service Name" style="flex:2">
            <select id="svc-cat" style="flex:1">
                <option value="Instagram">Instagram</option>
                <option value="YouTube">YouTube</option>
                <option value="Telegram">Telegram</option>
                <option value="Facebook">Facebook</option>
                <option value="Twitter">Twitter</option>
                <option value="Other">Other</option>
            </select>
            <input type="number" id="svc-price" placeholder="‚Çπ Price / 1k" style="flex:1">
            <div style="display:flex; gap:10px; width:100%;">
                <input type="number" id="svc-min" placeholder="Min" style="flex:1">
                <input type="number" id="svc-max" placeholder="Max" style="flex:1">
            </div>
            <button onclick="addService()">ADD SERVICE</button>
        </div>
        
        <div class="table-responsive">
            <table>
                <thead><tr><th>Cat</th><th>Name</th><th>Min/Max</th><th>‚Çπ/1k</th><th>Action</th></tr></thead>
                <tbody id="services-table"></tbody>
            </table>
        </div>
    </div>

    <div class="section">
        <h2>üì¶ Recent Orders</h2>
        <div class="table-responsive">
            <table>
                <thead><tr><th>ID</th><th>User</th><th>Service</th><th>Qty</th><th>Price</th><th>Status</th><th>Action</th></tr></thead>
                <tbody id="orders-table"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- UPDATED CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyDwmaZ_HGBR7eyOnPgLGO6grxVMR_cUM04",
        authDomain: "trendysmmpanel.firebaseapp.com",
        databaseURL: "https://trendysmmpanel-default-rtdb.firebaseio.com",
        projectId: "trendysmmpanel",
        storageBucket: "trendysmmpanel.firebasestorage.app",
        messagingSenderId: "1038373553958",
        appId: "1:1038373553958:web:c637432468b71e7266e3e7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    // --- ADMIN LOGIN LOGIC ---
    const loginOverlay = document.getElementById('login-overlay');
    const dashboardContent = document.getElementById('dashboard-content');
    const loginForm = document.getElementById('adminLoginForm');
    const loginMsg = document.getElementById('login-msg');

    // Check Session on Load
    if (sessionStorage.getItem('admin_session') === 'active') {
        showDashboard();
    }

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const u = document.getElementById('admin-user').value.trim();
        const p = document.getElementById('admin-pass').value.trim();

        loginMsg.innerText = "Checking credentials...";
        loginMsg.style.color = "orange";

        // Check credentials against Firebase Database
        const authRef = db.ref('admin_auth');
        authRef.once('value', snapshot => {
            if (!snapshot.exists()) {
                // FIRST TIME SETUP: If no admin exists, create default
                authRef.set({ username: 'admin', password: 'admin123' });
                if (u === 'admin' && p === 'admin123') {
                    loginSuccess();
                } else {
                    loginMsg.innerText = "New System detected. Default User: admin, Pass: admin123";
                    loginMsg.style.color = "var(--primary)";
                }
            } else {
                // VERIFY CREDENTIALS
                const creds = snapshot.val();
                if (u === creds.username && p === creds.password) {
                    loginSuccess();
                } else {
                    loginMsg.innerText = "Invalid Username or Password";
                    loginMsg.style.color = "var(--danger)";
                }
            }
        });
    });

    function loginSuccess() {
        sessionStorage.setItem('admin_session', 'active');
        showDashboard();
    }

    function showDashboard() {
        loginOverlay.style.display = 'none';
        dashboardContent.style.display = 'block';
        initAdminPanel(); // Start loading data only after login
    }

    function adminLogout() {
        sessionStorage.removeItem('admin_session');
        location.reload();
    }

    // --- MAIN ADMIN LOGIC (Wrapped in init function) ---
    function initAdminPanel() {
        // 1. Load Stats & Settings
        db.ref('users').on('value', snap => document.getElementById('count-users').innerText = snap.numChildren());
        
        db.ref('settings/fakeCount').on('value', snap => {
            if(snap.exists()) document.getElementById('fake-count').value = snap.val();
        });

        // 2. Load Payment Requests
        db.ref('payments').on('value', snap => {
            const list = document.getElementById('payments-table');
            list.innerHTML = '';
            let pendingCount = 0;
            
            if(snap.exists()) {
                const data = snap.val();
                Object.keys(data).forEach(key => {
                    const p = data[key];
                    if(p.status === 'Pending') {
                        pendingCount++;
                        list.innerHTML += `
                            <tr>
                                <td>${p.username || 'Unknown'}</td>
                                <td style="color:var(--success); font-weight:bold;">‚Çπ${p.amount}</td>
                                <td>${p.txnId}</td>
                                <td>${new Date(p.date).toLocaleDateString()}</td>
                                <td>
                                    <button class="green" style="padding:5px 10px" onclick="processPayment('${key}', '${p.userId}', ${p.amount}, 'Completed')">‚úî</button>
                                    <button class="red" style="padding:5px 10px" onclick="processPayment('${key}', '${p.userId}', 0, 'Rejected')">‚úñ</button>
                                </td>
                            </tr>
                        `;
                    }
                });
            }
            document.getElementById('count-pay-req').innerText = pendingCount;
            if(pendingCount === 0) list.innerHTML = '<tr><td colspan="5">No pending requests</td></tr>';
        });

        // 3. Services Management
        db.ref('services').on('value', snap => {
            const list = document.getElementById('services-table');
            list.innerHTML = '';
            if(snap.exists()){
                snap.forEach(c => {
                    const s = c.val();
                    list.innerHTML += `
                    <tr>
                        <td><span class="badge" style="background:#444; color:white">${s.category}</span></td>
                        <td>${s.name}</td>
                        <td style="font-size:11px; color:#aaa;">${s.min} - ${s.max}</td>
                        <td style="color:var(--success); font-weight:bold;">‚Çπ${s.price}</td>
                        <td><button class="red" style="padding:5px 10px" onclick="deleteService('${c.key}')">X</button></td>
                    </tr>`;
                });
            }
        });

        // 4. Orders Management
        db.ref('orders').on('value', snap => {
            const list = document.getElementById('orders-table');
            list.innerHTML = '';
            const data = snap.val();
            if(data) {
                const orders = Object.keys(data).map(k => ({key: k, ...data[k]})).reverse();
                document.getElementById('count-orders').innerText = orders.length; 
                
                orders.slice(0, 20).forEach(o => {
                    let badgeClass = 'b-pending';
                    if(o.status === 'Completed') badgeClass = 'b-completed';
                    if(o.status === 'Canceled') badgeClass = 'b-canceled';

                    list.innerHTML += `
                        <tr>
                            <td>${o.key.substr(-4)}</td>
                            <td style="font-size:10px">${o.userId}</td>
                            <td style="font-size:11px;">${o.serviceName}</td>
                            <td>${o.quantity}</td>
                            <td>‚Çπ${o.price}</td>
                            <td><span class="badge ${badgeClass}">${o.status}</span></td>
                            <td>
                                <select onchange="updateOrderStatus('${o.key}', this.value)" style="padding:5px; margin:0; height:auto;">
                                    <option value="" disabled selected>Edit</option>
                                    <option value="Processing">Processing</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Canceled">Canceled</option>
                                </select>
                            </td>
                        </tr>`;
                });
            }
        });
    }

    // --- GLOBAL ACTIONS (Outside Init) ---
    function saveSettings() {
        const val = parseInt(document.getElementById('fake-count').value) || 0;
        db.ref('settings/fakeCount').set(val);
        alert("Settings Saved!");
    }

    function processPayment(paymentKey, userId, amount, status) {
        if(!confirm(`Mark this payment as ${status}?`)) return;

        const updates = {};
        updates[`payments/${paymentKey}/status`] = status;
        
        if(status === 'Completed') {
            db.ref(`users/${userId}/coins`).transaction(current => (current || 0) + amount);
        }

        db.ref().update(updates);
    }

    function addService() {
        const nameInput = document.getElementById('svc-name');
        const catInput = document.getElementById('svc-cat');
        const priceInput = document.getElementById('svc-price');
        const minInput = document.getElementById('svc-min');
        const maxInput = document.getElementById('svc-max');

        const name = nameInput.value.trim();
        const cat = catInput.value;
        const price = parseFloat(priceInput.value);
        const min = parseInt(minInput.value);
        const max = parseInt(maxInput.value);

        if(!name) { alert("Please enter a Service Name."); return; }
        if(isNaN(price)) { alert("Please enter a valid Price."); return; }
        if(isNaN(min)) { alert("Please enter a valid Minimum Quantity."); return; }
        if(isNaN(max)) { alert("Please enter a valid Maximum Quantity."); return; }

        db.ref('services').push({ 
            name: name, 
            category: cat, 
            price: price, 
            min: min, 
            max: max, 
            active: true 
        }, (error) => {
            if (error) {
                alert("Error: " + error.message);
            } else {
                alert("Service Added Successfully! ‚úÖ");
                nameInput.value = '';
                priceInput.value = '';
                minInput.value = '';
                maxInput.value = '';
            }
        });
    }

    function deleteService(key) {
        if(confirm("Are you sure you want to delete this service?")) {
            db.ref('services/' + key).remove();
        }
    }

    function updateOrderStatus(key, status) {
        db.ref('orders/' + key).update({status: status});
    }

    function findAndUpdateBalance() {
        const username = document.getElementById('coin-username').value.trim().toLowerCase();
        const amount = parseFloat(document.getElementById('coin-amount').value);
        
        if(!username || !amount) return alert("Enter Username and Amount");

        db.ref('users').orderByChild('username').equalTo(username).once('value', snap => {
            if(snap.exists()) {
                let userKey = Object.keys(snap.val())[0];
                db.ref(`users/${userKey}/coins`).transaction(curr => (curr || 0) + amount);
                alert(`Added ‚Çπ${amount} to ${username}`);
                document.getElementById('coin-username').value = '';
                document.getElementById('coin-amount').value = '';
            } else {
                alert("User not found!");
            }
        });
    }

    function uploadQR() {
        const file = document.getElementById('qr-file').files[0];
        if(!file) return alert("Please select a file first");
        
        const ref = storage.ref('qrcodes/' + file.name);
        ref.put(file).then(s => s.ref.getDownloadURL()).then(url => {
            db.ref('settings/qrCodeUrl').set(url);
            document.getElementById('qr-status').innerText = "QR Updated Successfully!";
        }).catch(err => {
            alert("Upload failed: " + err.message);
        });
    }
</script>
</body>
</html>